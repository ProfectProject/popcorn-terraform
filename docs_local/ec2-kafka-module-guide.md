# EC2 Kafka ëª¨ë“ˆ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

`ec2-kafka` ëª¨ë“ˆì€ AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì— Apache Kafkaë¥¼ KRaft ëª¨ë“œë¡œ ë°°í¬í•˜ëŠ” Terraform ëª¨ë“ˆì…ë‹ˆë‹¤. ê°œë°œ í™˜ê²½(ë‹¨ì¼ ë…¸ë“œ)ê³¼ ìš´ì˜ í™˜ê²½(3ë…¸ë“œ í´ëŸ¬ìŠ¤í„°) ëª¨ë‘ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### ê°œë°œ í™˜ê²½ (Dev)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           VPC (10.0.0.0/16)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     App Subnet (Private)        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚   EC2 Instance (t3.micro)   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - Kafka Broker + Controllerâ”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - Port: 9092 (Broker)     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - Port: 9094 (Controller) â”‚ â”‚ â”‚
â”‚  â”‚  â”‚   - JMX: 9999               â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìš´ì˜ í™˜ê²½ (Prod)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VPC (10.0.0.0/16)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   AZ-2a (App)   â”‚ â”‚   AZ-2c (App)   â”‚ â”‚   AZ-2d (App)   â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ Kafka Node1 â”‚ â”‚ â”‚ â”‚ Kafka Node2 â”‚ â”‚ â”‚ â”‚ Kafka Node3 â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ (t3.small)  â”‚ â”‚ â”‚ â”‚ (t3.small)  â”‚ â”‚ â”‚ â”‚ (t3.small)  â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ Broker+Ctrl â”‚ â”‚ â”‚ â”‚ Broker+Ctrl â”‚ â”‚ â”‚ â”‚ Broker+Ctrl â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ íŒŒì¼ êµ¬ì¡° ë° ì—­í• 

### 1. `variables.tf` - ì…ë ¥ ë³€ìˆ˜ ì •ì˜
**ì—­í• **: ëª¨ë“ˆì˜ ì„¤ì • ê°€ëŠ¥í•œ ë§¤ê°œë³€ìˆ˜ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.

**ì£¼ìš” ë³€ìˆ˜ë“¤**:
```hcl
# í•„ìˆ˜ ë³€ìˆ˜
variable "name"              # ë¦¬ì†ŒìŠ¤ ê¸°ë³¸ ì´ë¦„
variable "environment"       # í™˜ê²½ (dev/prod)
variable "key_name"         # SSH í‚¤í˜ì–´ ì´ë¦„
variable "subnet_ids"       # ë°°í¬í•  ì„œë¸Œë„· ëª©ë¡
variable "security_group_id" # ë³´ì•ˆ ê·¸ë£¹ ID

# ì„ íƒì  ë³€ìˆ˜ (ê¸°ë³¸ê°’ ìˆìŒ)
variable "node_count"        # ë…¸ë“œ ìˆ˜ (ê¸°ë³¸: 1)
variable "instance_type"     # ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… (ê¸°ë³¸: t3.micro)
variable "data_volume_size"  # ë°ì´í„° ë³¼ë¥¨ í¬ê¸° (ê¸°ë³¸: 20GB)
```

**ì—°ê²° ë°©ì‹**: 
- í™˜ê²½ ë ˆë²¨(`envs/dev/main.tf`)ì—ì„œ ëª¨ë“ˆ í˜¸ì¶œ ì‹œ ê°’ ì „ë‹¬
- í™˜ê²½ë³„ `terraform.tfvars`ì—ì„œ ì‹¤ì œ ê°’ ì •ì˜

### 2. `main.tf` - í•µì‹¬ ë¦¬ì†ŒìŠ¤ ì •ì˜
**ì—­í• **: AWS ë¦¬ì†ŒìŠ¤ë“¤ì„ ìƒì„±í•˜ê³  êµ¬ì„±í•©ë‹ˆë‹¤.

**ì£¼ìš” ë¦¬ì†ŒìŠ¤ë“¤**:

#### ğŸ” **ë°ì´í„° ì†ŒìŠ¤**
```hcl
data "aws_ami" "amazon_linux"  # Amazon Linux 2 ìµœì‹  AMI ìë™ ì„ íƒ
```

#### ğŸ² **í´ëŸ¬ìŠ¤í„° ID ìƒì„±**
```hcl
resource "random_uuid" "cluster_id"  # KRaft ëª¨ë“œìš© ê³ ìœ  í´ëŸ¬ìŠ¤í„° ID
```

#### ğŸ’» **EC2 ì¸ìŠ¤í„´ìŠ¤**
```hcl
resource "aws_instance" "kafka"
```
- **ê°œìˆ˜**: `var.node_count`ë§Œí¼ ìƒì„±
- **ë°°ì¹˜**: ì„œë¸Œë„· ê°„ ë¼ìš´ë“œë¡œë¹ˆ ë°©ì‹
- **ìŠ¤í† ë¦¬ì§€**: 
  - ë£¨íŠ¸ ë³¼ë¥¨: 8GB (ì•”í˜¸í™”)
  - ë°ì´í„° ë³¼ë¥¨: 20GB (ì•”í˜¸í™”, /dev/sdf)
- **ì‚¬ìš©ì ë°ì´í„°**: `user_data.sh` í…œí”Œë¦¿ íŒŒì¼ ì‚¬ìš©

#### ğŸŒ **DNS ë ˆì½”ë“œ** (ì„ íƒì )
```hcl
resource "aws_route53_record" "kafka"
```
- **í˜•ì‹**: `kafka-{environment}-{node_id}`
- **ì˜ˆì‹œ**: `kafka-dev-1.internal.example.com`

#### ğŸ“Š **CloudWatch ë¡œê·¸ ê·¸ë£¹**
```hcl
resource "aws_cloudwatch_log_group" "kafka"
```
- **ë¡œê·¸ ê·¸ë£¹**: `/aws/ec2/kafka-{environment}`
- **ë³´ì¡´ ê¸°ê°„**: 7ì¼ (ê¸°ë³¸ê°’)

### 3. `outputs.tf` - ì¶œë ¥ ê°’ ì •ì˜
**ì—­í• **: ë‹¤ë¥¸ ëª¨ë“ˆì´ë‚˜ ìƒìœ„ ë ˆë²¨ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°’ë“¤ì„ ì¶œë ¥í•©ë‹ˆë‹¤.

**ì£¼ìš” ì¶œë ¥ê°’ë“¤**:
```hcl
output "instance_ids"        # ì¸ìŠ¤í„´ìŠ¤ ID ëª©ë¡
output "private_ips"         # í”„ë¼ì´ë¹— IP ëª©ë¡  
output "bootstrap_servers"   # Kafka ì—°ê²° ë¬¸ìì—´ (ip1:9092,ip2:9092)
output "cluster_id"          # KRaft í´ëŸ¬ìŠ¤í„° ID
output "dns_names"           # DNS ë ˆì½”ë“œ FQDN ëª©ë¡
```

**ì—°ê²° ë°©ì‹**: 
- ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ `module.ec2_kafka.bootstrap_servers` í˜•íƒœë¡œ ì°¸ì¡°
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ì—ì„œ Kafka ì—°ê²° ì •ë³´ë¡œ ì‚¬ìš©

### 4. `user_data.sh` - ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
**ì—­í• **: EC2 ì¸ìŠ¤í„´ìŠ¤ ë¶€íŒ… ì‹œ Kafka ì„¤ì¹˜ ë° ì„¤ì •ì„ ìë™í™”í•©ë‹ˆë‹¤.

**ì£¼ìš” ë™ì‘ ê³¼ì •**:

#### ğŸ”§ **ì‹œìŠ¤í…œ ì¤€ë¹„**
```bash
# íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° ì„¤ì¹˜
- Java 17 (Amazon Corretto)
- CloudWatch ì—ì´ì „íŠ¸
- ëª¨ë‹ˆí„°ë§ ë„êµ¬ë“¤
```

#### ğŸ’¾ **ìŠ¤í† ë¦¬ì§€ ì„¤ì •**
```bash
# EBS ë³¼ë¥¨ ë§ˆìš´íŠ¸
- /dev/nvme1n1 ë˜ëŠ” /dev/xvdf ê°ì§€
- XFS íŒŒì¼ì‹œìŠ¤í…œ ìƒì„±
- /opt/kafkaì— ë§ˆìš´íŠ¸
- fstab ì˜êµ¬ ì„¤ì •
```

#### â˜• **Kafka ì„¤ì¹˜**
```bash
# Apache Kafka 4.1.1 ì„¤ì¹˜
- ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ ë° ì••ì¶• í•´ì œ
- kafka ì‚¬ìš©ì ìƒì„±
- ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
```

#### âš™ï¸ **í™˜ê²½ë³„ ì„¤ì •**

**ê°œë°œ í™˜ê²½ (ë‹¨ì¼ ë…¸ë“œ)**:
```properties
# server.properties
node.id=1
controller.quorum.voters=1@{private_ip}:9094
default.replication.factor=1
min.insync.replicas=1

# JVM ì„¤ì • (t3.micro ìµœì í™”)
-Xmx400M -Xms400M
```

**ìš´ì˜ í™˜ê²½ (3ë…¸ë“œ í´ëŸ¬ìŠ¤í„°)**:
```properties
# server.properties  
controller.quorum.voters=1@kafka-prod-1:9094,2@kafka-prod-2:9094,3@kafka-prod-3:9094
default.replication.factor=3
min.insync.replicas=2

# JVM ì„¤ì • (t3.small ìµœì í™”)
-Xmx1G -Xms1G
```

#### ğŸš€ **ì„œë¹„ìŠ¤ ì‹œì‘**
```bash
# systemd ì„œë¹„ìŠ¤ ë“±ë¡
- kafka.service íŒŒì¼ ìƒì„±
- ìë™ ì‹œì‘ ì„¤ì •
- ë…¸ë“œë³„ ì‹œì°¨ ì‹œì‘ (í´ëŸ¬ìŠ¤í„° ì•ˆì •ì„±)
```

## ğŸ”— ëª¨ë“ˆ ì—°ê²° ë°©ì‹

### 1. í™˜ê²½ ë ˆë²¨ì—ì„œ ëª¨ë“ˆ í˜¸ì¶œ
```hcl
# envs/dev/main.tf
module "ec2_kafka" {
  source = "../../modules/ec2-kafka"

  name              = var.ec2_kafka_name
  environment       = "dev"
  node_count        = var.ec2_kafka_node_count
  instance_type     = var.ec2_kafka_instance_type
  key_name          = var.ec2_kafka_key_name
  subnet_ids        = values(module.vpc.app_subnet_ids)
  security_group_id = module.security_groups.kafka_sg_id
  
  tags = var.tags
}
```

### 2. ë³´ì•ˆ ê·¸ë£¹ ì—°ê²°
```hcl
# modules/security-groupsì—ì„œ kafka ë³´ì•ˆ ê·¸ë£¹ ì œê³µ
output "kafka_sg_id" {
  value = aws_security_group.kafka.id
}

# í¬íŠ¸ 9092, 9094 ECSì—ì„œ ì ‘ê·¼ í—ˆìš©
```

### 3. VPC ì„œë¸Œë„· ì—°ê²°
```hcl
# VPC ëª¨ë“ˆì—ì„œ app_subnet_ids ì œê³µ
subnet_ids = values(module.vpc.app_subnet_ids)

# í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ë°°ì¹˜ (ë³´ì•ˆ)
```

### 4. ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œ Kafka ì‚¬ìš©
```hcl
# ECS íƒœìŠ¤í¬ ì •ì˜ì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì‚¬ìš©
environment = [
  {
    name  = "KAFKA_BOOTSTRAP_SERVERS"
    value = module.ec2_kafka.bootstrap_servers
  }
]
```

## ğŸ“Š í™˜ê²½ë³„ ì°¨ì´ì 

| í•­ëª© | Dev | Prod |
|------|-----|------|
| **ë…¸ë“œ ìˆ˜** | 1ê°œ | 3ê°œ |
| **ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…** | t3.micro | t3.small |
| **ë³µì œ íŒ©í„°** | 1 | 3 |
| **ìµœì†Œ ë™ê¸° ë³µì œë³¸** | 1 | 2 |
| **ë©”ëª¨ë¦¬ í• ë‹¹** | 400MB | 1GB |
| **ë¡œê·¸ ë³´ì¡´** | 12ì‹œê°„ | 168ì‹œê°„(7ì¼) |
| **ì‹œì‘ ì§€ì—°** | ì—†ìŒ | ë…¸ë“œë³„ 30ì´ˆ ê°„ê²© |

## ğŸ”§ ì‚¬ìš© ë°©ë²•

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```hcl
# envs/dev/terraform.tfvars
ec2_kafka_name         = "goorm-popcorn-dev"
ec2_kafka_node_count   = 1
ec2_kafka_instance_type = "t3.micro"
ec2_kafka_key_name     = "my-keypair"
```

### 2. ëª¨ë“ˆ ë°°í¬
```bash
cd envs/dev
terraform init
terraform plan
terraform apply
```

### 3. ì—°ê²° ì •ë³´ í™•ì¸
```bash
# Bootstrap servers ì¶œë ¥
terraform output ec2_kafka_bootstrap_servers

# ì¸ìŠ¤í„´ìŠ¤ IP í™•ì¸
terraform output ec2_kafka_private_ips
```

### 4. Kafka ìƒíƒœ í™•ì¸
```bash
# SSH ì ‘ì† í›„
sudo /opt/kafka/scripts/status.sh

# í† í”½ ëª©ë¡ í™•ì¸
/opt/kafka-current/bin/kafka-topics.sh --list --bootstrap-server localhost:9092
```

## ğŸš¨ ì£¼ì˜ì‚¬í•­

1. **í‚¤í˜ì–´ í•„ìˆ˜**: EC2 ì¸ìŠ¤í„´ìŠ¤ ì ‘ê·¼ì„ ìœ„í•´ í‚¤í˜ì–´ê°€ ë¯¸ë¦¬ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
2. **ë³´ì•ˆ ê·¸ë£¹**: security-groups ëª¨ë“ˆì´ ë¨¼ì € ë°°í¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
3. **ì„œë¸Œë„·**: VPC ëª¨ë“ˆì´ ë¨¼ì € ë°°í¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
4. **IAM ê¶Œí•œ**: CloudWatch ë¡œê·¸ ì „ì†¡ì„ ìœ„í•œ IAM ì—­í• ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
5. **ë°ì´í„° ë°±ì—…**: ìš´ì˜ í™˜ê²½ì—ì„œëŠ” EBS ìŠ¤ëƒ…ìƒ· ì •ì±…ì„ ë³„ë„ë¡œ ì„¤ì •í•˜ì„¸ìš”.

## ğŸ” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Kafka ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
```bash
sudo systemctl status kafka
sudo journalctl -u kafka -f
```

### ë¡œê·¸ í™•ì¸
```bash
# ì„¤ì¹˜ ë¡œê·¸
sudo tail -f /var/log/kafka-setup.log

# Kafka ë¡œê·¸
sudo tail -f /opt/kafka/logs/server.log
```

### ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
```bash
# í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸
sudo netstat -tlnp | grep -E ':(9092|9094|9999)'

# ë³´ì•ˆ ê·¸ë£¹ ê·œì¹™ í™•ì¸ (AWS CLI)
aws ec2 describe-security-groups --group-ids sg-xxxxxxxxx
```